<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <title>{% block title %}Moja Aplikacja{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='dania.css') }}"> -->
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='planner.css') }}"> -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"> -->
</head>

<body>

    <!-- Modal wyboru składnika z products.json -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <h3>Wybierz składnik</h3>

            <!-- Pole do filtrowania produktów -->
            <input type="text" id="productSearch" placeholder="Szukaj produktu..." oninput="filterProducts()"
                style="width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 12px; border: 1px solid #e5e7eb;">

            <div id="productsList" style="max-height: 300px; overflow-y: auto;"></div>

            <label>Ilość (gram):</label>
            <input type="number" id="productGrams" placeholder="g" value="0">

            <div class="modal-buttons">
                <button class="save-btn" onclick="selectProduct()">Dodaj</button>
                <button class="close-btn" onclick="closeProductModal()">Zamknij</button>
            </div>
        </div>
    </div>

    <!-- Kontener główny strony -->
    <div class="container">
        <!-- Nawigacja -->
        <nav class="main-nav" id="mainNav">
            <div class="nav-highlight" id="navHighlight"></div>
            <a class="nav-link {% if request.path in ['/', '/planner'] %}active{% endif %}" href="/">Planner</a>
            <a class="nav-link {% if request.path == '/zakupy' %}active{% endif %}" href="/zakupy">Lista zakupów</a>
            <a class="nav-link {% if request.path == '/dania' %}active{% endif %}" href="/dania">Dania</a>
            <a class="nav-link {% if request.path == '/produkty' %}active{% endif %}" href="/produkty">Lista produktów</a>
        </nav>

        <!-- Główna treść -->
        <div class="page-content" id="pageContent">
            {% block content %}
            {% endblock %}
        </div>
    </div>

    <!-- Popup edycji produktu -->
    <div class="modal" id="editProductModal">
        <div class="modal-content">

            <div class="modal-header">
                <h3>Edytuj produkt</h3>
                <button class="modal-close" onclick="Controller.closeEditPopup()">×</button>
            </div>

            <form id="editForm">

                <input type="hidden" id="edit_id">

                <label>Nazwa produktu</label>
                <input type="text" id="edit_nazwa" class="modern-input">
                <label>Jednostka</label>
                <select id="edit_jednostka" class="modern-input">
                    {% for j in jednostki %}
                    <option value="{{ j }}">{{ j }}</option>
                    {% endfor %}
                </select>

                <label>Ilość gram w jednostce</label>
                <input type="number" id="edit_gramy" class="modern-input", step="any">

                <label>Kcal</label>
                <input type="number" id="edit_kcal" class="modern-input", step="any">

                <label>Białko</label>
                <input type="number" id="edit_b" class="modern-input", step="any">

                <label>Tłuszcz</label>
                <input type="number" id="edit_t" class="modern-input", step="any">

                <label>Węglowodany</label>
                <input type="number" id="edit_w" class="modern-input", step="any">

                <label>Czy w lodówce?</label>
                <select id="edit_lodowka" class="modern-input">
                    <option value="Tak">Tak</option>
                    <option value="Nie">Nie</option>
                    <option value="Tak/Nie">Tak/Nie</option>
                </select>

                <div class="modal-buttons">
                    <button type="submit" class="save-btn" id="modalSubmitBtn">Zapisz</button>
                    <button type="button" class="close-btn" onclick="Controller.closeEditPopup()">Anuluj</button>
                </div>

            </form>

        </div>
    </div>

    <div class="modal" id="deletePopup">
        <div class="modal-content">

            <div class="modal-header">
                <h3>Usunąć produkt?</h3>
                <button class="modal-close" onclick="Controller.closeDeletePopup()">×</button>
            </div>

            <p id="deleteMessage"></p>

            <div class="modal-buttons">
                <button id="deleteYes" class="delete-btn">Usuń</button>
                <button id="deleteNo" class="close-btn">Anuluj</button>
            </div>

        </div>
    </div>

    <div class="modal" id="successPopup">
        <div class="modal-content">

            <div class="modal-header">
                <h3>Produkt dodany!</h3>
                <button class="modal-close" onclick="Controller.closeSuccessPopup()">×</button>
            </div>

            <p>Czy chcesz dodać nowy produkt?</p>

            <div class="modal-buttons">
                <button id="addAnotherYes" class="main-btn">Tak</button>
                <button id="addAnotherNo" class="close-btn">Nie</button>
            </div>

        </div>
    </div>

    <!-- Modal przeniesiony poza container, zawsze na środku ekranu -->
    <div class="modal" id="mealModal">
        <div class="modal-content">
            <input type="hidden" id="mealId">

            <label>Nazwa</label>
            <input type="text" id="mealName">

            <label>Opis</label>
            <textarea id="mealDescription" class="modal-mealDescription"></textarea>

            <label>Składniki</label>
            <div id="ingredientsContainer"></div>

            <button type="button" class="main-btn" onclick="openProductModal()">+ Dodaj składnik</button>


            <div class="modal-buttons">
                <button class="save-btn" onclick="saveMeal()">Zapisz</button>
                <button class="delete-btn" onclick="deleteMeal()">Usuń</button>
                <button class="close-btn" onclick="closeModal()">Zamknij</button>
            </div>
        </div>
    </div>

    <script>
        // ===== Animowany przesuwający się highlight w nav =====
        const nav = document.getElementById("mainNav");
        const highlight = document.getElementById("navHighlight");
        let productsData = [];  // Przechowywać pełną listę produktów

        // Otwórz modal i załaduj produkty
        function openProductModal() {
            fetch("/api/products")
                .then(res => res.json())
                .then(data => {
                    productsData = data;  // Zapisz pełną listę produktów w zmiennej
                    renderProductList(data);
                    document.getElementById("productModal").classList.add("show");
                });
        }

        // Renderowanie listy produktów
        function renderProductList(data) {
            const list = document.getElementById("productsList");
            list.innerHTML = "";  // Czyścimy listę przed załadowaniem nowych produktów

            data.forEach(p => {
                const item = document.createElement("div");
                item.className = "product-item";
                item.style.padding = "6px";
                item.style.cursor = "pointer";
                item.style.borderBottom = "1px solid #e5e7eb";
                item.innerText = p.nazwa_produktu;
                item.dataset.id = p.id;
                item.dataset.name = p.nazwa_produktu;

                item.onclick = () => {
                    selectedProductId = p.id;
                    document.getElementById("productGrams").value = 0;
                    document.querySelectorAll("#productsList .product-item")
                        .forEach(el => el.style.background = "transparent");
                    item.style.background = "#e5e7eb";
                };

                list.appendChild(item);
            });
        }

        // Filtrowanie produktów na podstawie wprowadzonego tekstu
        function filterProducts() {
            const searchQuery = document.getElementById("productSearch").value.toLowerCase();
            const filteredProducts = productsData.filter(p => p.nazwa_produktu.toLowerCase().includes(searchQuery));
            renderProductList(filteredProducts);
        }

        // Zamknięcie modalu produktu
        function closeProductModal() {
            document.getElementById("productModal").classList.remove("show");
            selectedProductId = null;
        }

        function moveHighlight(el) {
            const rect = el.getBoundingClientRect();
            const navRect = nav.getBoundingClientRect();
            highlight.style.width = rect.width + "px";
            highlight.style.left = (rect.left - navRect.left) + "px";
        }

        // na start ustaw highlight na aktywnym linku
        document.addEventListener("DOMContentLoaded", () => {
            const active = nav.querySelector(".nav-link.active");
            if (active) moveHighlight(active);

            // hover effect
            nav.querySelectorAll(".nav-link").forEach(link => {
                link.addEventListener("mouseenter", () => moveHighlight(link));
                link.addEventListener("mouseleave", () => {
                    const active = nav.querySelector(".nav-link.active");
                    if (active) moveHighlight(active);
                });
            });
        });

        // ===== Animacja ładowania strony =====
        document.addEventListener("DOMContentLoaded", () => {
            const content = document.getElementById("pageContent");
            setTimeout(() => content.classList.add("show"), 50);
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pl.js"></script>
</body>

</html>