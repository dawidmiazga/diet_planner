<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <title>{% block title %}Moja Aplikacja{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='dania.css') }}"> -->
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='planner.css') }}"> -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"> -->
</head>

<body>

    <!-- Modal wyboru składnika z products.json -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header fancy-header">
                <h3>Wybierz składnik</h3>
            </div>

            <button class="fancy-close-btn" onclick="closeProductModal()" aria-label="Zamknij">
                <span class="close-icon">✕</span>
            </button>

            <!-- Pole do filtrowania produktów -->
            <input type="text" id="productSearch" placeholder="Szukaj produktu..." oninput="filterProducts()"
                style="width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 12px; border: 1px solid #e5e7eb;">

            <div id="productsList" style="max-height: 300px; overflow-y: auto;"></div>

            <label>Ilość (gram):</label>
            <input type="number" id="productGrams" placeholder="g" value="0">

            <div class="modal-buttons">
                <button class="btn save-btn" onclick="selectProduct()">Dodaj</button>
            </div>
        </div>
    </div>

    <!-- Kontener główny strony -->
    <div class="container">
        <!-- Nawigacja -->
        <nav class="main-nav" id="mainNav">
            <div class="nav-highlight" id="navHighlight"></div>
            <a class="nav-link {% if request.path in ['/', '/planner'] %}active{% endif %}" href="/">Planner</a>
            <a class="nav-link {% if request.path == '/zakupy' %}active{% endif %}" href="/zakupy">Lista zakupów</a>
            <a class="nav-link {% if request.path == '/dania' %}active{% endif %}" href="/dania">Dania</a>
            <a class="nav-link {% if request.path == '/produkty' %}active{% endif %}" href="/produkty">Lista
                produktów</a>
        </nav>

        <!-- Główna treść -->
        <div class="page-content" id="pageContent">
            {% block content %}
            {% endblock %}
        </div>
    </div>

    <!-- Popup edycji produktu -->
    <div class="modal" id="editProductModal">
        <div class="modal-content modal-product-form">

            <div class="modal-header fancy-header">
                <h3 id="editModalTitle"></h3>
            </div>

            <button class="fancy-close-btn" onclick="Controller.closeEditPopup()" aria-label="Zamknij">
                <span class="close-icon">✕</span>
            </button>

            <form id="editForm">
                <input type="hidden" id="edit_id">

                <div class="form-field full-width">
                    <label>Nazwa produktu</label>
                    <input type="text" id="edit_nazwa" class="modern-input">
                </div>

                <div class="form-field">
                    <label>Jednostka</label>
                    <select id="edit_jednostka" class="modern-input">
                        {% for j in jednostki %}
                        <option value="{{ j }}">{{ j }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-field">
                    <label>Ilość gram w jednostce</label>
                    <input type="number" id="edit_gramy" class="modern-input" step="any">
                </div>

                <div class="form-field">
                    <label for="edit_dzial">Dział w sklepie</label>
                    <select id="edit_dzial" class="modern-input">
                        <option value="">-- wybierz dział --</option>
                        {% for dzial in dzialy %}
                        <option value="{{ dzial }}">{{ dzial }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-field">
                    <label>Czy w lodówce?</label>
                    <select id="edit_lodowka" class="modern-input">
                        <option value="Tak">Tak</option>
                        <option value="Nie">Nie</option>
                        <option value="Tak/Nie">Tak/Nie</option>
                    </select>
                </div>

                <div class="macro-section">
                    <div class="macro-title">Makroskładniki (na 100g)</div>

                    <div class="macro-grid">

                        <div class="form-field">
                            <label>Kcal</label>
                            <input type="number" id="edit_kcal" class="modern-input" step="any">
                        </div>

                        <div class="form-field">
                            <label>Białko</label>
                            <input type="number" id="edit_b" class="modern-input" step="any">
                        </div>

                        <div class="form-field">
                            <label>Tłuszcz</label>
                            <input type="number" id="edit_t" class="modern-input" step="any">
                        </div>

                        <div class="form-field">
                            <label>Węglowodany</label>
                            <input type="number" id="edit_w" class="modern-input" step="any">
                        </div>

                    </div>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn save-btn" id="modalSubmitBtn">Zapisz</button>
                    <button type="button" class="btn red-btn" onclick="Controller.closeEditPopup()">Anuluj</button>
                </div>

            </form>

        </div>
    </div>

    <div class="modal" id="deletePopup">
        <div class="modal-content modal-delete-product">

            <div class="modal-header fancy-header">
                <h3>Usunąć produkt?</h3>
            </div>

            <button class="fancy-close-btn" onclick="Controller.closeDeletePopup()" aria-label="Zamknij">
                <span class="close-icon">✕</span>
            </button>

            <p id="deleteMessage"></p>

            <div class="modal-buttons">
                <button id="deleteYes" class="btn red-btn">Usuń</button>
                <button id="deleteNo" class="btn cancel-btn">Anuluj</button>
            </div>

        </div>
    </div>

    <div class="modal" id="successPopup">
        <div class="modal-content">

            <div class="modal-header fancy-header">
                <h3>Produkt dodany!</h3>
            </div>

            <button class="fancy-close-btn" onclick="Controller.closeSuccessPopup()" aria-label="Zamknij">
                <span class="close-icon">✕</span>
            </button>

            <p>Czy chcesz dodać nowy produkt?</p>

            <div class="modal-buttons">
                <button id="addAnotherYes" class="main-btn">Tak</button>
                <button id="addAnotherNo" class="red-btn">Nie</button>
            </div>

        </div>
    </div>
    <!-- Modal wyboru dania (Planner) -->
    <div class="modal" id="plannerMealModal">
        <div class="modal-content">

            <div class="modal-header fancy-header">
                <h3>Wybierz danie</h3>
            </div>

            <button class="fancy-close-btn" onclick="closePlannerMealModal()" aria-label="Zamknij">
                <span class="close-icon">✕</span>
            </button>

            <input type="hidden" id="cellDish">
            <input type="hidden" id="cellDate">

            <input type="text" id="mealSearch" placeholder="Szukaj dan..." class="meal-search-input">

            <div id="mealTiles" class="meal-tiles"></div>
        </div>
    </div>
    <!-- Modal opisu dania (Planner) -->
    <div class="modal" id="mealDescriptionModal">
        <div class="modal-content">

            <div class="modal-header fancy-header">
                <h3 id="descriptionTitle"></h3>
            </div>

            <button class="fancy-close-btn" onclick="closeDescriptionModal()" aria-label="Zamknij">
                <span class="close-icon">✕</span>
            </button>

            <div id="descriptionContent" class="meal-description-layout">
                <div id="mealDescriptionLeft" class="meal-description-left"></div>
                <div id="mealDescriptionRight" class="meal-description-right"></div>
            </div>
        </div>
    </div>
    <!-- Modal przeniesiony poza container, zawsze na środku ekranu -->
    <div class="modal" id="mealModal">
        <div class="modal-content modal-meal-layout">
            <div class="modal-title-with-stars">
                <!-- <h3>Edytuj danie</h3>                 -->
                <h3 id="editModalTitleMeal"></h3>
                <div id="mealRating" class="star-rating">
                    <span data-value="1"></span>
                    <span data-value="2"></span>
                    <span data-value="3"></span>
                    <span data-value="4"></span>
                    <span data-value="5"></span>
                </div>
            </div>

            <button class="fancy-close-btn" onclick="closeModal()" aria-label="Zamknij">
                <span class="close-icon">✕</span>
            </button>

            <input type="hidden" id="mealId">

            <div class="meal-modal-grid">

                <!-- LEWA STRONA -->
                <div class="meal-left">

                    <label>Nazwa</label>
                    <input type="text" id="mealName" class="modern-input">

                    <label>Osoba</label>
                    <div id="mealPersonSelection" class="dish-selection"></div>

                    <label>Numer dania</label>
                    <div id="dishSelection" class="dish-selection"></div>

                    <label>Opis</label>
                    <textarea id="mealDescription" class="modal-mealDescription"></textarea>

                </div>

                <!-- PRAWA STRONA -->
                <div class="meal-right">

                    <div class="ingredients-header">
                        <label>Składniki</label>
                        <button type="button" class="btn main-btn small-btn" onclick="openProductModal()">+
                            Dodaj</button>
                    </div>

                    <div id="ingredientsContainer" class="ingredients-list"></div>

                </div>

            </div>

            <div class="modal-buttons">
                <button class="btn save-btn" onclick="saveMeal()">Zapisz</button>
                <button class="btn red-btn" id="deleteMealBtn" onclick="confirmDeleteMeal()">Usuń</button>
            </div>

        </div>
    </div>

    <script>
        const DISH_CONFIG = {
            osoba1: {
                1: "Śniadanie",
                2: "II Śniadanie",
                3: "Obiad",
                4: "Kolacja",
                5: "Przekąska"
            },
            osoba2: {
                1: "Śniadanie",
                2: "Obiad",
                3: "Kolacja",
                4: "Przekąska"
            }
        };

        // ===== Animowany przesuwający się highlight w nav =====
        const nav = document.getElementById("mainNav");
        const highlight = document.getElementById("navHighlight");
        let productsData = [];  // Przechowywać pełną listę produktów

        // Otwórz modal i załaduj produkty
        function openProductModal() {
            fetch("/api/products")
                .then(res => res.json())
                .then(data => {
                    productsData = data;  // Zapisz pełną listę produktów w zmiennej
                    renderProductList(data);
                    document.getElementById("productModal").classList.add("show");
                });
        }

        // Renderowanie listy produktów
        function renderProductList(data) {
            const list = document.getElementById("productsList");
            list.innerHTML = "";  // Czyścimy listę przed załadowaniem nowych produktów

            data.forEach(p => {
                const item = document.createElement("div");
                item.className = "product-item";
                item.style.padding = "6px";
                item.style.cursor = "pointer";
                item.style.borderBottom = "1px solid #e5e7eb";
                item.innerText = p.nazwa_produktu;
                item.dataset.id = p.id;
                item.dataset.name = p.nazwa_produktu;

                item.onclick = () => {
                    selectedProductId = p.id;
                    document.getElementById("productGrams").value = 0;
                    document.querySelectorAll("#productsList .product-item")
                        .forEach(el => el.style.background = "transparent");
                    item.style.background = "#e5e7eb";
                };

                list.appendChild(item);
            });
        }

        // Filtrowanie produktów na podstawie wprowadzonego tekstu
        function filterProducts() {
            const searchQuery = document.getElementById("productSearch").value.toLowerCase();
            const filteredProducts = productsData.filter(p => p.nazwa_produktu.toLowerCase().includes(searchQuery));
            renderProductList(filteredProducts);
        }

        // Zamknięcie modalu produktu
        function closeProductModal() {
            const modal = document.getElementById("productModal");

            modal.classList.add("closing");

            setTimeout(() => {
                modal.classList.remove("show");
                modal.classList.remove("closing");
                selectedProductId = null;
            }, 200);
        }

        function moveHighlight(el) {
            const rect = el.getBoundingClientRect();
            const navRect = nav.getBoundingClientRect();
            highlight.style.width = rect.width + "px";
            highlight.style.left = (rect.left - navRect.left) + "px";
        }

        // na start ustaw highlight na aktywnym linku
        document.addEventListener("DOMContentLoaded", () => {
            const active = nav.querySelector(".nav-link.active");
            if (active) moveHighlight(active);

            // hover effect
            nav.querySelectorAll(".nav-link").forEach(link => {
                link.addEventListener("mouseenter", () => moveHighlight(link));
                link.addEventListener("mouseleave", () => {
                    const active = nav.querySelector(".nav-link.active");
                    if (active) moveHighlight(active);
                });
            });
        });

        // ===== Animacja ładowania strony =====
        document.addEventListener("DOMContentLoaded", () => {
            const content = document.getElementById("pageContent");
            setTimeout(() => content.classList.add("show"), 50);
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pl.js"></script>

    <script>
        /* ===== GLOBALNY SYSTEM MODALI ===== */

        function closeModalElement(modal) {
            if (!modal) return;

            modal.classList.add("closing");

            setTimeout(() => {
                modal.classList.remove("show");
                modal.classList.remove("closing");
            }, 200);
        }

        // ESC zamyka wszystkie otwarte modale
        document.addEventListener("keydown", function (e) {
            if (e.key === "Escape") {
                document.querySelectorAll(".modal.show").forEach(modal => {
                    closeModalElement(modal);
                });
            }
        });

        // Klik w tło zamyka modal
        document.addEventListener("click", function (e) {
            if (e.target.classList.contains("modal")) {
                closeModalElement(e.target);
            }
        });
    </script>

</body>

</html>