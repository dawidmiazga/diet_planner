{% extends "base.html" %}

{% block title %}Planner{% endblock %}

{% block content %}




<div class="toolbar">
    <div class="toolbar-left">

        <!-- Wyb√≥r daty startowej -->
        <div class="date-picker-wrapper">
            <label for="startDate">üìÖ Data startowa</label>
            <input type="text" id="startDate" class="modern-date-input">
        </div>
    </div>
    <div class="toolbar-center">

        <!-- Wyb√≥r osoby -->
        <div class="tabs" id="personTabs">
            <div class="tab active" onclick="setPerson('osoba1', this)">Dawid</div>
            <div class="tab" onclick="setPerson('osoba2', this)">Kasia</div>
        </div>
    </div>
    <div class="toolbar-spacer">
        <div class="switch-container">
            <label class="switch">
                <input type="checkbox" id="editModeSwitch" onclick="toggleEditMode()" checked>
                <span class="slider round"></span>
            </label>
            <span id="editModeLabel">Tryb PodglƒÖdu</span>
        </div>

    </div>
</div>





<!-- Nowoczesna tabelka jako grid -->
<div class="planner-grid" id="plannerGrid"></div>

<!-- Modal wyboru dania -->
<!-- <div class="modal" id="mealModal">
    <div class="modal-content">


        <div class="modal-header">
            <h3>Wybierz danie</h3>
            <button class="btn modal-close" onclick="closeModal()">√ó</button>
        </div>

        <input type="hidden" id="cellDish">
        <input type="hidden" id="cellDate">

        <input type="text" id="mealSearch" placeholder="Szukaj dan..." class="meal-search-input">

        <div id="mealTiles" class="meal-tiles"></div>
    </div>

</div> -->

<!-- Modal opisu dania -->
<!-- <div class="modal" id="mealDescriptionModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="descriptionTitle"></h3>
            <button class="btn modal-close" onclick="closeDescriptionModal()">√ó</button>
        </div>

        <div id="descriptionContent" class="meal-description-layout">
            <div id="mealDescriptionLeft" class="meal-description-left"></div>
            <div id="mealDescriptionRight" class="meal-description-right"></div>
        </div>
    </div>
</div> -->

<style>
    /* ===== Planner Grid ===== */
    /* .planner-grid {
        display: grid;
        grid-template-columns: 150px repeat(5, 1fr);
        gap: 15px;
        margin-top: 30px;
    }

    .planner-grid .header,
    .planner-grid .cell {
        padding: 20px;
        border-radius: 16px;
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        text-align: center;
        cursor: pointer;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s, box-shadow 0.2s;
        font-weight: 500;
    }

    .planner-grid .header {
        background: var(--pr    imary);
        color: white;
    }

    .planner-grid .cell:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    } */
</style>

<script>
    let currentPerson = "osoba1";
    let meals = [];
    let products = [];

    let plannerData = { "osoba1": {}, "osoba2": {} };

    let isEditMode = false;  // Domy≈õlnie ustawiamy tryb edycji

    // Funkcja prze≈ÇƒÖczajƒÖca tryb edycji/podglƒÖdu
    // Funkcja prze≈ÇƒÖczajƒÖca tryb edycji/podglƒÖdu
    function toggleEditMode() {
        isEditMode = !isEditMode;  // Prze≈ÇƒÖcz stan trybu
        document.getElementById("editModeLabel").textContent = isEditMode ? "Tryb Edycji" : "Tryb PodglƒÖdu";
        renderPlanner();  // Ponownie renderujemy planner, aby zaktualizowaƒá zachowanie kom√≥rek
    }


    // Funkcja wywo≈Çywana po klikniƒôciu w kom√≥rkƒô
    // function handleCellClick(dateStr, dish) {
    //     if (isEditMode) {
    //         openMealModal(dateStr, dish);  // W trybie edycji otwieramy modal do wyboru dania
    //     } else {
    //         const mealId = plannerData[currentPerson][dateStr]?.[dish] || "";
    //         const meal = meals.find(m => m.id === mealId);
    //         if (meal) {
    //             openDescriptionModal(meal);  // W trybie podglƒÖdu pokazujemy modal z opisem
    //         }
    //     }
    // }

    // Zmodyfikuj funkcjƒô renderujƒÖcƒÖ planner, aby reagowa≈Ça na tryb edycji
    function renderPlanner() {
        const startDateInput = document.getElementById("startDate").value;
        if (!startDateInput) return;

        const startDate = new Date(startDateInput);
        const grid = document.getElementById("plannerGrid");
        grid.innerHTML = "";

        const maxDishes = currentPerson === "osoba1" ? 5 : 4;
        grid.style.gridTemplateColumns = `150px repeat(${maxDishes}, 1fr)`;

        // nag≈Ç√≥wki kolumn
        grid.appendChild(createHeaderCell("Data"));
        for (let dish = 1; dish <= maxDishes; dish++) {
            grid.appendChild(createHeaderCell(DISH_CONFIG[currentPerson][dish]));
        }
// 
        // wiersze = daty
        for (let row = 0; row < 5; row++) {
            const d = new Date(startDate);
            d.setDate(d.getDate() + row);
            const dateStr = d.toISOString().split('T')[0];

            // kom√≥rka daty
            grid.appendChild(createCell(d.toLocaleDateString('pl-PL', { weekday: 'short', day: 'numeric', month: 'numeric' })));

            for (let dish = 1; dish <= maxDishes; dish++) {
                const mealId = plannerData[currentPerson][dateStr]?.[dish] || "";
                const meal = meals.find(m => m.id === mealId);
                const cellText = meal ? meal.name : "-";

                const cell = createCell(cellText, "cell");

                // klikniƒôcie w kom√≥rkƒô otwiera popup tylko je≈õli jest danie
                cell.onclick = () => openMealModal(dateStr, dish);

                // dodajemy przycisk X tylko je≈õli jest wybrane danie i tylko w trybie edycji
                if (meal && isEditMode) {
                    const removeBtn = document.createElement("button");
                    removeBtn.textContent = "√ó";
                    removeBtn.className = "remove-meal-btn";

                    removeBtn.onclick = (e) => {
                        e.stopPropagation();
                        removeMeal(dateStr, dish);
                    };

                    cell.appendChild(removeBtn);
                }

                // // dodajemy przycisk notatki
                // if (meal) {
                //     const noteBtn = document.createElement("button");
                //     noteBtn.innerHTML = "üìù";
                //     noteBtn.className = "note-btn";

                //     noteBtn.onclick = (e) => {
                //         e.stopPropagation();
                //         openDescriptionModal(meal);
                //     };

                //     cell.appendChild(noteBtn);
                // }

                grid.appendChild(cell);
            }
        }
    }


    function createCell(text, cls = "cell") {
        const div = document.createElement("div");
        div.className = cls;
        if (!isEditMode) {
            div.classList.add("preview-mode");
        }
        div.textContent = text;
        return div;
    }


    document.addEventListener("DOMContentLoaded", () => {
        // const today = new Date().toISOString().split('T')[0];
        // document.getElementById("startDate").value = today;

        let startPicker;

        fetch("/api/get_planner_date")
            .then(res => res.json())
            .then(data => {

                startPicker = flatpickr("#startDate", {
                    locale: flatpickr.l10ns.pl,
                    dateFormat: "Y-m-d",
                    defaultDate: data.start_date ? data.start_date : new Date(),
                    allowInput: false,
                    animate: true,
                    onChange: function (selectedDates, dateStr) {

                        // üî• ZAPIS DO PLIKU
                        fetch("/api/save_planner_date", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({ start_date: dateStr })
                        });

                        renderPlanner();
                    }
                });

                renderPlanner();
            });


        Promise.all([
            fetch("/api/meals").then(res => res.json()),
            fetch("/api/load_planner").then(res => res.json()),
            fetch("/api/products").then(res => res.json())
        ])
            .then(([mealsData, plannerSaved, productsData]) => {
                meals = mealsData;
                plannerData = plannerSaved;
                products = productsData;
                renderPlanner();
            });

    });


    function savePlannerMeal(mealId) {
        const dish = parseInt(document.getElementById("cellDish").value);
        const dateStr = document.getElementById("cellDate").value;

        if (!plannerData[currentPerson][dateStr])
            plannerData[currentPerson][dateStr] = {};

        plannerData[currentPerson][dateStr][dish] = mealId;

        closePlannerMealModal();
        renderPlanner();

        // üî• AUTO ZAPIS
        fetch("/api/save_planner", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(plannerData)
        });

        showSaveNoticeGlobal();
    }

    function setPerson(person, el) {
        currentPerson = person;
        document.querySelectorAll("#personTabs .tab").forEach(t => t.classList.remove("active"));
        el.classList.add("active");
        renderPlanner();
    }

    // function renderPlanner() {
    //     const startDateInput = document.getElementById("startDate").value;
    //     if (!startDateInput) return;

    //     const startDate = new Date(startDateInput);
    //     const grid = document.getElementById("plannerGrid");
    //     grid.innerHTML = "";

    //     // nag≈Ç√≥wki kolumn
    //     grid.appendChild(createHeaderCell("Data"));
    //     for (let dish = 1; dish <= 5; dish++) {
    //         grid.appendChild(createHeaderCell("Posi≈Çek " + dish));
    //     }

    //     // wiersze = daty
    //     for (let row = 0; row < 5; row++) {
    //         const d = new Date(startDate);
    //         d.setDate(d.getDate() + row);
    //         const dateStr = d.toISOString().split('T')[0];

    //         // kom√≥rka daty
    //         grid.appendChild(createCell(d.toLocaleDateString('pl-PL', { weekday: 'short', day: 'numeric', month: 'numeric' })));

    //         for (let dish = 1; dish <= 5; dish++) {

    //             const mealId = plannerData[currentPerson][dateStr]?.[dish] || "";
    //             const meal = meals.find(m => m.id === mealId);
    //             const cellText = meal ? meal.name : "-";

    //             const cell = createCell(cellText, "cell");

    //             // klikniƒôcie w kom√≥rkƒô otwiera popup tylko je≈õli jest danie
    //             cell.onclick = () => openMealModal(dateStr, dish);

    //             // dodajemy przycisk X tylko je≈õli jest wybrane danie
    //             if (meal) {

    //                 // // üìí przycisk notatki
    //                 // const noteBtn = document.createElement("button");
    //                 // noteBtn.innerHTML = "üìù";
    //                 // noteBtn.className = "note-btn";

    //                 // noteBtn.onclick = (e) => {
    //                 //     e.stopPropagation();
    //                 //     openDescriptionModal(meal);
    //                 // };

    //                 // cell.appendChild(noteBtn);

    //                 // ‚ùå przycisk usuwania
    //                 const removeBtn = document.createElement("button");
    //                 removeBtn.textContent = "√ó";
    //                 removeBtn.className = "remove-meal-btn";

    //                 removeBtn.onclick = (e) => {
    //                     e.stopPropagation();
    //                     removeMeal(dateStr, dish);
    //                 };

    //                 cell.appendChild(removeBtn);
    //             }


    //             grid.appendChild(cell);
    //         }

    //     }
    // }
    function removeMeal(dateStr, dish) {
        // usu≈Ñ z danych
        if (plannerData[currentPerson][dateStr] && plannerData[currentPerson][dateStr][dish]) {
            delete plannerData[currentPerson][dateStr][dish];

            // je≈õli wiersz pusty, usu≈Ñ te≈º datƒô
            if (Object.keys(plannerData[currentPerson][dateStr]).length === 0) {
                delete plannerData[currentPerson][dateStr];
            }
        }

        renderPlanner();

        // auto zapis
        fetch("/api/save_planner", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(plannerData)
        });

        showSaveNoticeGlobal();
    }

    // nowa funkcja do nag≈Ç√≥wk√≥w z klasƒÖ osoby
    function createHeaderCell(text) {
        const div = document.createElement("div");
        div.className = "header " + (currentPerson === "osoba1" ? "header-osoba1" : "header-osoba2");
        div.textContent = text;
        return div;
    }

    // funkcja uniwersalna dla zwyk≈Çych kom√≥rek
    function createCell(text, cls = "cell") {
        const div = document.createElement("div");
        div.className = cls;
        div.textContent = text;
        return div;
    }
    function openDescriptionModal(meal) {
        document.getElementById("descriptionTitle").textContent = meal.name;

        const left = document.getElementById("mealDescriptionLeft");
        const right = document.getElementById("mealDescriptionRight");

        left.innerHTML = "";
        right.innerHTML = "";

        // ===== LEWA STRONA ‚Äî OPIS =====
        // ===== PRAWA STRONA ‚Äî OPIS (kroki) =====

        // let descriptionHTML = "<h4>Przygotowanie</h4>";

        // if (meal.description && meal.description.trim() !== "") {

        //     const steps = meal.description
        //         .split("\n")
        //         .map(step => step.trim())
        //         .filter(step => step.length > 0);

        //     descriptionHTML += "<ol>";

        //     steps.forEach(step => {
        //         descriptionHTML += `<li>${step}</li>`;
        //     });

        //     descriptionHTML += "</ol>";

        // } else {
        //     descriptionHTML += "<p>Brak opisu.</p>";
        // }

        // right.innerHTML = descriptionHTML;
        // ===== PRAWA STRONA ‚Äî PRZYGOTOWANIE (interaktywne kroki) =====

        let descriptionHTML = "<h4>Przygotowanie</h4>";

        if (meal.description && meal.description.trim() !== "") {

            const steps = meal.description
                .split("\n")
                .map(step => step.trim())
                .filter(step => step.length > 0);

            descriptionHTML += `<div class="steps-display-list">`;

            steps.forEach((step, index) => {
                descriptionHTML += `
            <div class="step-display-row" onclick="toggleStep(this)">
                <div class="step-number">${index + 1}.</div>
                <div class="step-text">${step}</div>
            </div>
        `;
            });

            descriptionHTML += `</div>`;

        } else {
            descriptionHTML += "<p>Brak opisu.</p>";
        }

        right.innerHTML = descriptionHTML;
        // ===== LEWA STRONA ‚Äî SK≈ÅADNIKI =====
        let ingredientsHTML = "<h4>Sk≈Çadniki</h4>";
        ingredientsHTML += `<div class="ingredients-display-list">`;

        meal.ingredients.forEach(ingredient => {
            const product = products.find(p => p.id === ingredient.id);

            let gramsPart = `${ingredient.grams}g`;
            let extraUnitPart = "";

            if (
                product &&
                product.jednostka_per_gram &&
                product.nazwa_jednostki &&
                product.nazwa_jednostki.toLowerCase() !== "gram"
            ) {
                let iloscJednostek = ingredient.grams / product.jednostka_per_gram;

                iloscJednostek = Number.isInteger(iloscJednostek)
                    ? iloscJednostek
                    : iloscJednostek.toFixed(1);

                extraUnitPart = ` (${iloscJednostek} ${product.nazwa_jednostki})`;
            }

            ingredientsHTML += `
        <div class="ingredient-display-row" onclick="toggleIngredient(this)">
            <div class="ingredient-display-name">
                ${ingredient.name}
            </div>
            <div class="ingredient-display-value">
                ${gramsPart}${extraUnitPart}
            </div>
        </div>
    `;
        });

        ingredientsHTML += `</div>`;
        left.innerHTML = ingredientsHTML;
        // ===== PRAWA STRONA ‚Äî SK≈ÅADNIKI =====
        // let ingredientsHTML = "<h4>Sk≈Çadniki</h4><ul>";

        // meal.ingredients.forEach(ingredient => {
        //     const product = products.find(p => p.id === ingredient.id);

        //     let jednostkaInfo = "";

        //     if (
        //         product &&
        //         product.jednostka_per_gram &&
        //         product.nazwa_jednostki &&
        //         product.nazwa_jednostki.toLowerCase() !== "gram"
        //     ) {
        //         let iloscJednostek = ingredient.grams / product.jednostka_per_gram;

        //         iloscJednostek = Number.isInteger(iloscJednostek)
        //             ? iloscJednostek
        //             : iloscJednostek.toFixed(1);

        //         jednostkaInfo = ` (${iloscJednostek} ${product.nazwa_jednostki})`;
        //     }

        //     ingredientsHTML += `
        //     <li>
        //         ${ingredient.name} - ${ingredient.grams}g${jednostkaInfo}
        //     </li>
        // `;
        // });

        // ingredientsHTML += "</ul>";
        // left.innerHTML = ingredientsHTML;

        document.getElementById("mealDescriptionModal").classList.add("show");
    }

    function toggleIngredient(element) {
        element.classList.toggle("checked");
    }

    function closeDescriptionModal() {
        document.getElementById("mealDescriptionModal").classList.remove("show");
    }

    // zamkniƒôcie po klikniƒôciu w t≈Ço

    function toggleStep(element) {
        element.classList.toggle("checked");
    }
    function openMealModal(dateStr, dish) {
        // Je≈õli edytujemy, to otwiera siƒô modal z wyborem dania
        if (isEditMode) {
            document.getElementById("cellDish").value = dish;
            document.getElementById("cellDate").value = dateStr;

            const container = document.getElementById("mealTiles");
            container.innerHTML = "";
            const options = meals.filter(m =>
                m.person === currentPerson &&
                Array.isArray(m.dish) &&
                m.dish.includes(Number(dish))
            );

            const selectedMealId = plannerData[currentPerson][dateStr]?.[dish] || null;

            if (options.length === 0) {
                container.innerHTML = "<p>Brak da≈Ñ dla tej osoby</p>";
            } else {
                options.forEach(m => {
                    const tile = document.createElement("div");
                    tile.className = "meal-tile";
                    if (m.id === selectedMealId) {
                        tile.classList.add("selected");
                    }
                    tile.innerHTML = `
                <div class="meal-name">${m.name}</div>
            `;
                    /*************  ‚ú® Windsurf Command ‚≠ê  *************/
                    /**
                     * Save the meal to the planner with the given id.
                     * @param {number} id - The id of the meal to save.
                     */
                    /*******  133551e3-55db-4208-a202-f0fd5a792d05  *******/
                    tile.onclick = () => {
                        savePlannerMeal(m.id);
                    };
                    container.appendChild(tile);
                });
            }

            document.getElementById("plannerMealModal").classList.add("show");

            const searchInput = document.getElementById("mealSearch");
            searchInput.value = "";

            setTimeout(() => {
                searchInput.focus();
            }, 220);

            function renderMealTiles(filterText = "") {
                container.innerHTML = "";

                const filteredOptions = options.filter(m =>
                    m.name.toLowerCase().includes(filterText.toLowerCase())
                );

                if (filteredOptions.length === 0) {
                    container.innerHTML = "<p>Brak da≈Ñ pasujƒÖcych do wyszukiwania</p>";
                } else {
                    filteredOptions.forEach(m => {
                        const tile = document.createElement("div");
                        tile.className = "meal-tile";
                        if (m.id === selectedMealId) {
                            tile.classList.add("selected");
                        }
                        tile.innerHTML = `<div class="meal-name">${m.name}</div>`;
                        tile.onclick = () => savePlannerMeal(m.id);
                        container.appendChild(tile);
                    });
                }
            }

            renderMealTiles();

            searchInput.oninput = (e) => {
                renderMealTiles(e.target.value);
            };
        } else {
            // Je≈õli podglƒÖd, to wy≈õwietl opis i sk≈Çadniki dania
            const mealId = plannerData[currentPerson][dateStr]?.[dish];
            const meal = meals.find(m => m.id === mealId);

            if (meal) {
                openDescriptionModal(meal);
            }
        }
    }






    /**
     * Closes the meal modal by removing the 'show' class from the modal element.
     */
    function closePlannerMealModal() {
        const modal = document.getElementById("plannerMealModal");
        closeModalElement(modal);
    }


    // zamkniƒôcie po klikniƒôciu w t≈Ço
    // document.getElementById("mealModal").addEventListener("click", function (e) {
    //     if (e.target === this) {
    //         closeModal();
    //     }
    // });
    function showSaveNoticeGlobal() {
        // sprawd≈∫, czy ju≈º istnieje
        let notice = document.querySelector(".save-notice-global");
        if (!notice) {
            notice = document.createElement("div");
            notice.className = "save-notice-global";
            notice.textContent = "Zapisano ‚úî";
            document.body.appendChild(notice);
        }

        // poka≈º
        notice.classList.add("show");

        // po 1,2 sekundy zniknij
        setTimeout(() => {
            notice.classList.remove("show");
        }, 1200);
    }

</script>

{% endblock %}